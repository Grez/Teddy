<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title></title>
	<script src="/js/teddy/md5.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
	<script>
		$(function() {

			function createSource(hash) {
				var source = new EventSource('/sse/default/' + hash);

				source.addEventListener('message', function(e) {
					source.close();
					var json = e.data;
					var data = JSON.parse(e.data);
					console.log(data);
					hash = md5(json);
					createSource(hash);
				}, false);

				source.addEventListener('open', function(e) {
					// Connection was opened.
				}, false);

				source.addEventListener('error', function(e) {
					if (e.readyState == EventSource.CLOSED) {
						// Connection was closed.
						console.log('closed');
					}
				}, false);

				return source;
			}

			if (!!window.EventSource) {

				var json  = '{"pm":{"unreadCount":"3"}}';
				var hash = md5(json);
				var source = createSource(hash);

			} else {
				// Result to xhr polling :(
				console.log('f≈àuk');
			}

		});
	</script>
</head>
<body>
	<h1>Server sent events</h1>


</body>
</html>
